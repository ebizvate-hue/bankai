<!DOCTYPE html>
<html>
  <head>
    <title>AR Video Marker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- اول Three.js -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <!-- بعد AR.js نسخه‌ی three -->
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/three.js/build/ar-threex.js"></script>
    <style>
      body, html {
        margin: 0;
        overflow: hidden;
        width: 100%;
        height: 100%;
        background: black;
      }
      video {
        display: none;
      }
    </style>
  </head>
  <body>
    <!-- ویدیو -->
    <video id="video" src="Carcar.mp4" playsinline webkit-playsinline></video>

    <script>
      // صحنه و دوربین
      let scene = new THREE.Scene();
      let camera = new THREE.Camera();
      scene.add(camera);

      let renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setClearColor(new THREE.Color('black'), 0);
      document.body.appendChild(renderer.domElement);

      // منبع AR (وبکم)
      let arSource = new THREEx.ArToolkitSource({ sourceType: 'webcam' });
      arSource.init(() => setTimeout(onResize, 2000));

      window.addEventListener('resize', onResize);
      function onResize(){
        arSource.onResizeElement();
        arSource.copyElementSizeTo(renderer.domElement);
        if (arContext.arController !== null) {
          arSource.copyElementSizeTo(arContext.arController.canvas);
        }
      }

      // کانتکست AR
      let arContext = new THREEx.ArToolkitContext({
        cameraParametersUrl: 'https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/three.js/data/camera_para.dat',
        detectionMode: 'mono'
      });
      arContext.init(() => {
        camera.projectionMatrix.copy(arContext.getProjectionMatrix());
      });

      // ریشه مارکر
      let markerRoot = new THREE.Group();
      scene.add(markerRoot);
      let markerControls = new THREEx.ArMarkerControls(arContext, markerRoot, {
        type: 'pattern',
        patternUrl: 'marker.patt'
      });

      // ویدیو
      let video = document.getElementById('video');
      let texture = new THREE.VideoTexture(video);
      texture.minFilter = THREE.LinearFilter;
      texture.magFilter = THREE.LinearFilter;
      texture.format = THREE.RGBFormat;

      // وقتی ویدیو لود شد -> Plane بساز
      video.addEventListener('loadedmetadata', () => {
        let aspect = video.videoWidth / video.videoHeight;
        let markerSize = 1;   // ضلع مارکر (واحد AR.js)
        let height = markerSize;      // بالا و پایین همتراز مارکر
        let width  = markerSize * aspect; // عریض‌تر از مارکر

        let geometry = new THREE.PlaneGeometry(width, height);
        let material = new THREE.MeshBasicMaterial({map: texture, side: THREE.DoubleSide});
        let mesh = new THREE.Mesh(geometry, material);
        markerRoot.add(mesh);
      });

      // حلقه رندر
      function animate(){
        requestAnimationFrame(animate);
        if (!arSource.ready) return;
        arContext.update(arSource.domElement);
        renderer.render(scene, camera);

        if(markerRoot.visible){
          if(video.paused) video.play();
        } else {
          if(!video.paused) video.pause();
        }
      }
      animate();
    </script>
  </body>
</html>
